<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <record id="crm_lead_view_form_inherit_mi_modulo" model="ir.ui.view">
      <field name="name">crm.lead.form.inherit.mi_modulo.aduana</field>
      <field name="model">crm.lead</field>
      <field name="inherit_id" ref="crm.crm_lead_view_form"/>
      <field name="arch" type="xml">

        <!-- SMART BUTTON -->
        <xpath expr="//div[@class='oe_button_box']" position="inside">
          <button type="action"
                  name="%(mi_modulo.mx_ped_operacion_action)d"
                  class="oe_stat_button"
                  icon="fa-file-text-o"
                  context="{'search_default_lead_id': active_id}">
            <field string="Pedimentos" name="x_ped_operacion_count" widget="statinfo"/>
          </button>
        </xpath>

        <!-- BOTÓN EN HEADER -->
        <xpath expr="//header" position="inside">
          <button name="action_crear_pedimento" type="object" string="Crear pedimento" class="btn-primary"/>
        </xpath>

        <!-- TABS -->
        <xpath expr="//notebook" position="inside">

          <page string="Operación" name="mi_modulo_operacion">
            <group>
              <group string="Identificación">
                <field name="x_tipo_operacion"/>
                <field name="x_folio_operacion"/>
                <field name="x_referencia_cliente"/>
                <field name="x_prioridad_operativa"/>
              </group>
              <group string="Responsables">
                <field name="x_ejecutivo_id"/>
                <field name="user_id"/>
                <field name="partner_id"/>
              </group>
            </group>
          </page>

          <page string="Aduana" name="mi_modulo_aduana">
            <group>
              <group string="Clasificación">
                <field name="x_regimen"/>
                <field name="x_tipo_despacho"/>
                <field name="x_aduana" placeholder="Ej. 070 / Tijuana"/>
                <field name="x_patente_agente"/>
                <field name="x_clave_pedimento"/>
              </group>
              <group string="Mercancía">
                <field name="x_fraccion_arancelaria_principal" placeholder="Ej. 9403.20.01"/>
                <field name="x_descripcion_mercancia"/>
                <field name="x_currency_id"/>
              </group>
            </group>
          </page>

          <page string="Logística" name="mi_modulo_logistica">
            <group>
              <group string="Ruta">
                <field name="x_modo_transporte"/>
                <field name="x_incoterm"/>
                <field name="x_pais_origen_id"/>
                <field name="x_pais_destino_id"/>
                <field name="x_lugar_carga"/>
                <field name="x_lugar_descarga"/>
              </group>
              <group string="Fechas">
                <field name="x_fecha_estimada_salida"/>
                <field name="x_fecha_estimada_arribo"/>
                <field name="x_fecha_recoleccion"/>
                <field name="x_fecha_entrega"/>
              </group>
            </group>
          </page>

          <page string="Partes" name="mi_modulo_partes">
            <group>
              <group string="Participantes">
                <field name="x_exportador_id"/>
                <field name="x_exportador_name"/>
                <field name="x_importador_id"/>
                <field name="x_importador_name"/>
                <field name="x_proveedor_id"/>
                <field name="x_proveedor_name"/>
              </group>
              <group string="Destino">
                <field name="x_consignatario_name"/>
                <field name="x_destinatario_final_name"/>
              </group>
            </group>
          </page>

          <page string="Documentos" name="mi_modulo_documentos">
            <group>
              <group string="Checklist">
                <field name="x_docs_requeridos_ids" widget="many2many_tags"/>
                <field name="x_docs_faltantes_text" placeholder="Ej. Falta factura, packing list, BL..."/>
                <field name="x_docs_completos" readonly="1"/>
              </group>
              <group string="Portal">
                <field name="x_visible_portal"/>
              </group>
            </group>
          </page>

          <page string="Valores" name="mi_modulo_valores">
            <group>
              <group string="Importes">
                <field name="x_valor_factura"/>
                <field name="x_valor_aduana_estimado"/>
                <field name="x_cotizacion_total"/>
                <field name="x_costo_estimado"/>
              </group>
              <group string="Cantidades">
                <field name="x_bultos"/>
                <field name="x_numero_paquetes"/>
                <field name="x_tipo_empaque"/>
                <field name="x_peso_bruto"/>
                <field name="x_peso_neto"/>
                <field name="x_volumen_cbm"/>
              </group>
            </group>
          </page>

          <page string="Transporte" name="mi_modulo_transporte">
            <group>
              <group string="Guías">
                <field name="x_bl_awb"/>
                <field name="x_house_bl_awb"/>
                <field name="x_booking"
                       modifiers='{"invisible":[["x_modo_transporte","!=","maritimo"]]}'/>
              </group>
              <group string="Equipo">
                <field name="x_num_contenedor"/>
                <field name="x_num_sello"/>
              </group>
            </group>
          </page>

          <!-- ✅ Pedimentos relacionados -->
          <page string="Pedimentos" name="mi_modulo_pedimentos_rel">
            <group>
              <group string="Acciones">
                <button name="action_crear_pedimento" type="object" string="Crear pedimento desde este lead" class="btn-primary"/>
              </group>
            </group>

            <field name="x_ped_operacion_ids" nolabel="1" context="{'default_lead_id': active_id}" mode="list,form">
              <list editable="bottom">
                <field name="name"/>
                <field name="tipo_operacion"/>
                <field name="regimen"/>
                <field name="aduana_clave"/>
                <field name="patente"/>
                <field name="clave_pedimento"/>
                <field name="pedimento_numero"/>
                <field name="fecha_pago"/>
                <field name="fecha_liberacion"/>
                <field name="semaforo"/>
              </list>

              <form string="Pedimento">
                <sheet>
                  <div class="oe_title">
                    <h1><field name="name" placeholder="Ej. OP-0001"/></h1>
                  </div>

                  <group>
                    <group string="Clasificación">
                      <field name="lead_id" readonly="1"/>
                      <field name="tipo_operacion"/>
                      <field name="regimen"/>
                      <field name="incoterm"/>
                      <field name="aduana_clave"/>
                      <field name="patente"/>
                      <field name="clave_pedimento"/>
                      <field name="currency_id"/>
                    </group>

                    <group string="Resultado">
                      <field name="pedimento_numero"/>
                      <field name="fecha_pago"/>
                      <field name="semaforo"/>
                      <field name="fecha_liberacion"/>
                    </group>
                  </group>

                  <group>
                    <group string="Observaciones">
                      <field name="observaciones"/>
                    </group>
                  </group>
                </sheet>
              </form>
            </field>
          </page>

        </xpath>
      </field>
    </record>

  </data>
</odoo>